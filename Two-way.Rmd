---
title: "Многофакторный дисперсионный анализ на примере two-way ANOVA"
author: "Лаврентий Данилов"
date: "21.11.2020"
output:
    html_document:
      toc: true
      toc_depth: 3
      toc_float: true
      number_section: true
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(car)
library(Hmisc)
library(multcomp)
theme_set(theme_bw())
```

# Данные

## Структура данных

**Источник данных (скорее вдохновения)**: Reassess the t Test: Interact with All Your Data via ANOVA  http://www.plantcell.org/content/27/8/2088 


Идея работы с симулированными данными пришла в голову после теоретической статьи о сравнении зффективности дисперсионного анализа и множественного t-теста. Хотелось показать, что интересные работы не всегда требуют практических вложений.

Чтобы лекция не представляла собой сферическое создание в ваукуме придумаем легенду к нашей симуляции))

Предположим, что на одном из спутников Юпитера обнаружилась жизнь. Генетический анализ покзал, что популяция склиссов имеет два аллеля гена, отвечающего за форму ушей: дикий тип со стоячими ушами (*WT*) и редкая вислоухая мутация (*М1*). Склиссов начали активно изучать и посместили в культуру с двумя условиями содержания: условия, приближенные к условиям спутника (UnTr) и условия, характерные для Земли (Tr). 

Исследователей интересовал вопрос будет ли зависеть минимальная воспринимаемая частота звука от фенотипа и условий содержания склиссов. 


Создадим набор данных, моделирующий результаты подобного эксперимента.

```{r}
set.seed(1402)

WT=rnorm(7, mean=20, sd=5) ### Дикий тип без воздействия
M1=rnorm(7, mean=16, sd=5) ### Вислоухие без воздействия
M2=rnorm(7, mean=32, sd=5) ### Дикий тип в земных условиях
DM=rnorm(7, mean=22, sd=5) ### Вислоухие в земных условиях
Gene <- c(rep("M1", 7), rep("WT", 7), rep( "M1",7),  rep( "WT", 7))
Treatment <- c(rep("UnTr",14), rep ("Tr", 14))
Sound <- c(WT, M1, M2, DM)

skliss <- data.frame(Gene,Treatment, Sound)
skliss$Gene <- factor(skliss$Gene)
skliss$Treatment <- factor(skliss$Treatment)
skliss$Condition<-factor(paste(skliss$Gene, skliss$Treatment))

str(skliss)
```

## Визуализация

Оценим графически результаты симуляции. Субьективно кажется, что какие-то различия между группами имеются. Будем проверять.

```{r}
gg_range <- ggplot(data = skliss, aes(x = Gene , y = Sound, colour = Treatment)) +
  stat_summary(geom = 'pointrange', fun.data = mean_cl_normal, position = position_dodge(width = 0.2)) + ggtitle("График зависимости воспрининаемого звука от условий содержания\n и генетического разообразия")
gg_range
```

# Анализ

## Двуфакторная ANOVA

На прошлой лекции мы выяснили, что вместо множественных попарных сравнений лучше применять дисперсионный анализ. Но как поступить, если нас интересует более чем один дискретный фактор? Применить множественный дисперсионный анализ! Да, такой тоже бывает. И даже не один. О MANOVA и permANOVA мы поговорим на одной из будущих лекций. А сегодня речь пойдет про two-way ANOVA. 

Идейно она не отличается от однофакторного дисперсионного анализа. Только число групп сравнения формируется по типу таблицы собряженности. В нашем случае их будет 4 (2 аллеля * 2 условия содержания)

Модель записывается как для множественной линейной регрессии. 

```{r}
s_model <- lm(Sound ~ Gene + Treatment , data=skliss)
simple<-Anova(mod = s_model)
```
### Условия применимости

Дисперсионный анализ имеет сходные с линейными моделями условия применимости. А именно...

- нормальное распределение остатков
- гомогенность дисперсий остатков
- отсутствие коллинеарности (независимость групп)
- случайность и независимость наблюдений в группах

Дисперсионный анализ становится устойчивее к отклонениям условий при больших объемах выборок или при равных объемах групп. 

Сомнения вызывает график остатков. При равных дисперсиях групп мы видим смещение медианных значений. Возможно, наша модель что-то не учитывает...

```{r}
simple_diag <- fortify(s_model) # функция из пакета ggplot2

ggplot(simple_diag, aes(x = 1:nrow(simple_diag), y = .cooksd)) +
  geom_bar(stat = 'identity')
```


```{r}
ggplot(data = simple_diag, aes(x = Gene, y = .stdresid, colour = Treatment)) +
  geom_boxplot() + geom_hline(yintercept = 0)

qqPlot(s_model, id = FALSE) 
```

## Двуфакторная ANOVA со взаимодействием 

Если внимательно посмотреть на график первичных данных, то можно заподозрить взаимодействие предикторов. Условия содержания явно по разному сказываются в зависимости от формы аллели. Учтем это в нашей модели.

```{r}
inter_model <- lm(Sound ~ Gene * Treatment , data=skliss)
inter<-Anova(mod = inter_model)
```

### Условия применимости

График остатков выглядит гораздо лучше. 

```{r}
inter_diag <- fortify(inter_model) # функция из пакета ggplot2

ggplot(simple_diag, aes(x = 1:nrow(inter_diag), y = .cooksd)) +
  geom_bar(stat = 'identity')

ggplot(data = inter_diag, aes(x = Gene, y = .stdresid, colour = Treatment)) +
  geom_boxplot() + geom_hline(yintercept = 0)

qqPlot(inter_model, id = FALSE) 
```
 
### Интерпретация результатов

```{r echo = FALSE}
inter
```

Если в модели оказывается значимо взаимодействие, то главные эффекты обсуждать не имеет смысла!!!

Результаты для статьи должны выглядеть подобным образом...

**Сочетание формы аллели и условий содержания значимо влияет на среднюю минимальную различаемую частоту звука у склиссов (F =`r inter[[3]][3]` , p_value = `r inter[[4]][3]`, df_1 = `r inter[[2]][3]`, df_2 = `r inter[[2]][4]`)  **

## Пост-хок тесты

Дисперсионный анализ говорит нам только, влияет ли фактор в целом. Но не говорит, какие именно группы различаются. Чтобы это узнать необходимо сделать пост-хок тесты. 

Пост-хок тесты --- серия попарных сравнений средних значений в группах **после того, как выявлено значимое влияние фактора**. От обычных попарных сравнений они отличаются тем, что учитывают число сравнений и величину различий между средними.

Мы будем использвать пост-хок тест Тьюки (есть и другие).  

```{r}
# Подбираем линейную модель без свободного члена
fit_inter <- lm(Sound ~ Condition - 1, data = skliss)
# Делаем пост хок тест для этой модели
dat_tukey <- glht(fit_inter, linfct = mcp(Condition= 'Tukey'))
summary(dat_tukey)

```


**В условиях, характерных для спутника генетический полиморфизм не оказывает никакого влияния на минимальную воспринимаемую частоту звука у склиссов. В то время как в земных условиях носители аллели вислоухости имеют более высокий частотный порог восприятия**

## Визуализация

Результаты пост-хок теста можно отобразить в виде графика. 

```{r}
MyData <- expand.grid(Gene = levels(skliss$Gene),
                      Treatment = levels(skliss$Treatment))
MyData <- data.frame(
  MyData,
  predict(inter_model, newdata = MyData, interval = 'confidence')
)

pos <- position_dodge(width = 0.2)
gg_linep <- ggplot(data = MyData, aes(x = Treatment, y = fit,
                                      ymin = lwr, ymax = upr, colour = Gene)) +
  geom_point(position = pos) +
  geom_errorbar(position = pos, width =0.2 )
gg_linep

```


