---
title: "Линейные модели с дискретными предикторами"
author: "Лаврентий Данилов"
date: "14.11.2020"
output:
    html_document:
      toc: true
      toc_depth: 3
      toc_float: true
      number_section: true
---
# Теория
Ранее мы разбирали линейные модели, включавшие в себя непрерывные предикторы. На предыдущих лекциях мы коснулись теоретической части, касающейся моделей, где наравне с непрерывными присутствует и дискретный предиктор. В такой ситуации используется dummy-переменная, задача которой "переключать" модель между уровнями группирующего фактора.  

## Проблема множественных сравнений

Однако нередко возникает задача сравнить между собой несколько групп по какому-то признаку. Мы уже умеем сравнивать между собой две группы с помощью t-теста. Почему нельзя применить этот метод для сравнения нескольких групп? Провести серию попарных сравнений... 

Нельзя. И причина этого лежит в логике тестирования. Мы помним, что при применении t-теста мы фиксируем вероятность ошибки 1 рода. Обычно это 0.05, то есть мы готовы ошибаться в 5% случаев при тестировании гипотезы. Теперь представьте, что у вас несколько групп, как в наших сегодняшних данных. Тогда при проведении m сравнений верхняя оценка вероятности того, что хотя бы один из них будет неверным, равна ..., что достаточно велико уже при небольших m (например, при m=5 она равна..). 

## Дисперсионный анализ

Есть несколько способов избежать завышения вероятности ошибки 1 рода. Один из них - дисперсионный анализ. Другие способы (например, поправки на множественные сравнения) см. в презентации.

**Дисперсионный анализ в широком смысле** --- это анализ изменений непрерывной зависимой переменной в связи с разными источниками изменчивости (предикторами). Мы использовали его для тестирования значимости предикторов в линейных моделях.

**Дисперсионный анализ в узком смысле** --- это частный случай, когда в линейной модели используются только дискретные предикторы (факторы). Он используется для сравнения средних значений зависимой переменной в дискретных группах.

Именно им мы сейчас и займемся.


```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(car)
library(Hmisc)
library(multcomp)
library(gridExtra)
theme_set(theme_bw())
```

# Данные

## Структура данных

**Источник данных**: A.M. Griffin and W.G. McCarten (1949). "Some Methods for the
Quantitative Study of Entozoic Amoebae in Cultures," The Journal of
Parasitology


**Описание**: Число эксцистирований энтерозойных амеб для 5 условий обработки.

**Условия**:

1 = Контроль (None)

2 = Нагрев 70С в течение 10 минут (Heat_70C)

3 = Добавление 10% раствора формалина (10%_formalin)

4 = Нагревание с последующим добавлением формалина (Heat+formalin)

5 = Добавление формалина с последующим нагреванием в течение часа (Formalin+heat)


```{r}
amoeba <- read.csv("/home/lavrentydanilov/Documents/Documents/IB/Teaching/2020-2021_year/Data/amoeba.csv")
amoeba$Condition <- factor(amoeba$Condition, labels = c("None", "Heat_70C", "10%_formalin", "Heat+formalin", "Formalin+heat"))
str(amoeba)
```

Данные обладают полезным свойством, а именно в каждой группе находится одно и то же число наблюдений. Это делает дисперсионный анализ дополнительно устойчивым. Поэтому на будущее, если решите применять ANOVA, то старайтесь планировать свои эксперименты подобным образом. 

```{r}
table(amoeba$Condition)
```

Чтобы знать, чего можно ожидать, посмотрим на исходные данные.

```{r}
ggplot(amoeba, aes(Condition, Yield, color = Condition)) + stat_summary(fun.data = "mean_cl_normal") + ggtitle(label = "График зависимости числа эксцистирований \nот условий обработки (исходные данные)")
```

## Линейная модель с дискретным предиктором

Подберем линейную модел зависимости числа эксцистирований от условий обработки. Посмотрим на `summary()` данной модели.

```{r}
mod_amoeba <- lm(Yield ~ Condition, data = amoeba)
summary(mod_amoeba)
```

Для модели t-тесты угловых коэффициентов показывают значимость отличий средних значений в группах от среднего на базовом уровне. В нашем случае базовый уровень это контроль. По значениям коэффициентов нельзя сказать влияет ли дискретный фактор целиком, кроме случая, где фактор имеет 2 градации. 
## Дисперсия
```{r}
#theme_set(theme_bw())

#Общая изменчивость
total<-ggplot(amoeba, aes(x = Condition, y = Yield))+ geom_linerange(aes(x=Condition, ymax=Yield, ymin = mean(amoeba$Yield)), size = 1,color = "grey",position = position_jitter(width = 0.1, seed = 1L))+
  geom_hline(yintercept = mean(amoeba$Yield))+ 
  geom_point(position = position_jitter(width = 0.1, seed = 1L)) +ggtitle("Общая \n изменчивость")+theme(axis.text.x = element_text(angle = 45, hjust = 1))



gr_mean<-amoeba %>% group_by(Condition) %>% summarise(mean = mean(Yield))

two_pic<-right_join(x = amoeba, y = gr_mean)

hline <- data.frame(Condition=levels(amoeba$Condition), v=gr_mean$mean)


resid<-ggplot(two_pic, aes(x = Condition, y = Yield)) + geom_linerange(aes(x=Condition, ymax=Yield, ymin = mean), size = 1,color = "green", position = position_jitter(width = 0.1, seed = 1L)) +geom_point(position = position_jitter(width = 0.1, seed = 1L)) +geom_point(data=hline, aes(Condition, v), shape=95, size=15) +ggtitle("Случайная \n изменчивость")+theme(axis.text.x = element_text(angle = 45, hjust = 1))

factor <- ggplot() +  geom_linerange(data = gr_mean, aes(x= Condition, ymax = mean, ymin = mean(amoeba$Yield)), color = "blue", size = 2)+geom_point(data = two_pic, aes(x = Condition, y = Yield), position = position_jitter(width = 0.1, seed = 1L)) +geom_point(data=hline, aes(Condition, v), shape=95, size=15) +geom_hline(yintercept = mean(amoeba$Yield)) + ggtitle("Факторная \n изменчивость")+theme(axis.text.x = element_text(angle = 45, hjust = 1))


grid.arrange(total, factor, resid, nrow = 1)
```

## ANOVA

Для проведения дисперсионного анализа воспользуемся функцией `Anova()`. Посмотрим на результаты. Мы видим, что фактор `Condition` значимо влияет на число эксцистирований амеб. 

```{r}
amoeba_anova <- Anova(mod_amoeba)
amoeba_anova
```

 Результаты для статьи должны выглядеть подобным образом
 
**Число эксцистирований амеб значимо зависит от условий инкубации (F =`r amoeba_anova[[3]][1]` , p_value = `r amoeba_anova[[4]][1]`, df_1 = `r amoeba_anova[[2]][1]`, df_2 = `r amoeba_anova[[2]][2]`).**

### Условия применимости

Дисперсионный анализ имеет сходные с линейными моделями условия применимости. А именно...

- нормальное распределение остатков
- гомогенность дисперсий остатков
- отсутствие коллинеарности (независимость групп)
- случайность и независимость наблюдений в группах

Дисперсионный анализ снановится устойчивее к отклонениям условий при больших объемах выборок или при равных объемах групп (как раз наш случай). 

```{r}
mod_diag <- fortify(mod_amoeba)

ggplot(mod_diag, aes(x = 1:nrow(mod_diag), y = .cooksd)) + geom_bar(stat = "identity") + ggtitle("График расстояний Кука")

ggplot(mod_diag, aes(x = Condition, y = .stdresid)) + geom_boxplot() + ggtitle("График остатков")
```

Мы видим разброс дисперсий в группах, но так как в каждой из групп у нас равное число наблюдений, то это не критично. 

```{r}
qqPlot(mod_amoeba, id = FALSE, main = "Квантильный график остаков")
```

## Пост-хок тесты

Дисперсионный анализ говорит нам только, влияет ли фактор в целом. Но не говорит, какие именно группы различаются. Чтобы это узнать необходимо сделать пост-хок тесты. 

Пост-хок тесты --- серия попарных сравнений средних значений в группах **после того, как выявлено значимое влияние фактора**. От обычных попарных сравнений они отличаются тем, что учитывают число сравнений и величину различий между средними.

Мы будем использвать пост-хок тест Тьюки (есть и другие).  

```{r}
post_hoch <- glht(mod_amoeba, linfct = mcp(Condition = "Tukey"))
result<-summary(post_hoch)
result
```

Итого мы видим, что было произведено 10 попарных сравнений. Значимые различия были обнаружены только между 3 парами:

- Heat_70C - None
- 10%_formalin - None
- Formalin+heat - None

Результаты пост-хок теста для статьи должны выглядеть примерно так...

**Для вывявления попарных различий был проведен пост-хок тест Тьюки (df = `r result$df`). Число эксцистирований в контроле значимо выше, чем при обработках температурой (F = `r result$coef[[2]]`, p_value = `r result$test$pvalues[1]` ), 10% формалином(F = `r result$coef[[3]]`, p_value = `r result$test$pvalues[2]`) и формалином с температурой( F = `r result$coef[[5]]`, p_value = `r result$test$pvalues[4]`)**

## Визуализация

Результаты пост-хок теста можно отобразить в виде графика. 

```{r}
MyData <- data.frame(Condition = factor(levels(amoeba$Cond), levels = levels(amoeba$Condition)))
MyData <- data.frame(MyData,
  predict(mod_amoeba, newdata = MyData, interval = "confidence")
)

gg_bars <- ggplot(data = MyData, aes(x = Condition, y = fit)) +
  geom_bar(stat = "identity", aes(fill = Condition), width = 0.5) +
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.1)

gg_bars + ggtitle(label = "График зависимости числа эксцистирований \nот условий обработки (пост-хок тест)") + geom_text(aes(y = 1.6, label = c("*", "*", "*", "", "*"))) + ylab(label = "Yield")
```

# Послесловие
Линейные модели один из самых мощных инструментов фриквинтистской статистики. С их помощью можно решать очень широкий спектр задач. 

Мы с вами разобрали основные типы линейных моделей: простые, множественные и дисперсионный анализ. Вскользь коснулись такого большого раздела как взаимодействие предикторов. К нему же относится и двуфакторный дисперсионный анализ, о котором мы не успели поговорить совсем. Но знайте, что он существует))

Помимо классических LM есть также такие большие разделы как обобщенные линейные модели (Generalised linear model, GLM), смешанные линейные модели (Generalised linear mixed model), линейные модели с инфляцией нулей (Zero-Inflation linear model) и другие. Они применяются там, где базовые линейные модели не подходят или из-за условий применимости, или из-за постановки задачи исследования.

Но даже сейчас мы с вами не прощаемся с линейными моделями насовсем. В следующем семестре в рамках курса по машинному обучению нас ждет разбор метода логистической линейной модели. 
